<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMLTV Viewer v5.4 - Debug Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .debug-line {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }
        
        .debug-error {
            color: #ff6666;
            font-weight: bold;
        }
        
        .debug-success {
            color: #66ff66;
        }
        
        .debug-info {
            color: #66ccff;
        }

        /* Treemap Styles */
        .treemap-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 800px;
            margin: 0 auto;
            background: #f0f0f0;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        .treemap-item {
            position: absolute;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            font-weight: bold;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .treemap-item:hover {
            transform: scale(1.05);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .fill-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
        <h3 style="color: #00ff00; margin-bottom: 10px;">üîç DEBUG CONSOLE</h3>
        <div id="debugContent"></div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">XMLTV Viewer v5.4 - Debug Version</h1>
            <p class="text-gray-600">Versione con debug completo per diagnostica</p>
        </div>

        <!-- File Upload -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <p class="text-xl mb-4">Trascina qui il file XMLTV o clicca per selezionare</p>
                <input type="file" id="fileInput" accept=".xml" class="hidden">
                <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                    Seleziona File XML
                </button>
                <div class="mt-4">
                    <button onclick="loadTestFile()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                        Carica File di Test
                    </button>
                </div>
            </div>
        </div>

        <!-- Channel Info -->
        <div id="channelInfo" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Informazioni Canale</h2>
            <p>Canale: <span id="channelName" class="font-bold"></span></p>
            <p>ID: <span id="channelId" class="text-gray-600"></span></p>
            <p>Programmi: <span id="programCount" class="font-bold"></span></p>
        </div>

        <!-- Treemap -->
        <div id="treemapSection" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Treemap Aggregato per Format</h2>
            <div class="treemap-container" id="treemapContainer">
                <div class="fill-indicator" id="fillIndicator">0% riempito</div>
            </div>
        </div>

        <!-- Program List -->
        <div id="programList" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-bold mb-4">Lista Programmi</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">Ora Inizio</th>
                            <th class="px-4 py-2 text-left">Ora Fine</th>
                            <th class="px-4 py-2 text-left">Titolo</th>
                            <th class="px-4 py-2 text-left">Durata</th>
                        </tr>
                    </thead>
                    <tbody id="programTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Debug logging
        const debugLog = (message, type = 'info') => {
            const debugContent = document.getElementById('debugContent');
            const line = document.createElement('div');
            line.className = `debug-line debug-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            debugContent.appendChild(line);
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        };

        // Global variables
        let xmlDoc = null;
        let programs = [];
        let channelId = '';
        let channelName = '';

        // Color palette
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B195', '#F67280',
            '#C06C84', '#6C5B7B', '#355C7D', '#2ECC71', '#3498DB'
        ];

        // Initialize
        debugLog('XMLTV Viewer v5.4 inizializzato', 'success');

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            debugLog('File selezionato: ' + e.target.files[0]?.name);
            if (e.target.files.length > 0) {
                loadFile(e.target.files[0]);
            }
        });

        // Load file
        function loadFile(file) {
            debugLog(`Caricamento file: ${file.name} (${file.size} bytes)`);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('File letto con successo');
                try {
                    parseXML(e.target.result);
                } catch (error) {
                    debugLog(`Errore parsing: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function(e) {
                debugLog(`Errore lettura file: ${e.target.error}`, 'error');
            };
            
            reader.readAsText(file);
        }

        // Parse XML
        function parseXML(xmlString) {
            debugLog('Inizio parsing XML...');
            
            const parser = new DOMParser();
            xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            
            // Check for parse errors
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                debugLog('Errore nel parsing XML: ' + parseError.textContent, 'error');
                return;
            }
            
            debugLog('XML parsato correttamente', 'success');
            
            // Get channel info
            const channelElement = xmlDoc.querySelector('channel');
            if (!channelElement) {
                debugLog('Nessun elemento channel trovato', 'error');
                return;
            }
            
            channelId = channelElement.getAttribute('id') || 'Unknown';
            const displayNameElement = channelElement.querySelector('display-name');
            channelName = displayNameElement ? displayNameElement.textContent : channelId;
            
            debugLog(`Canale trovato: ${channelName} (ID: ${channelId})`, 'success');
            
            // Get programs
            const programElements = xmlDoc.querySelectorAll('programme');
            debugLog(`Trovati ${programElements.length} elementi programme`);
            
            programs = [];
            
            programElements.forEach((prog, index) => {
                try {
                    const start = prog.getAttribute('start');
                    const stop = prog.getAttribute('stop');
                    const title = prog.querySelector('title')?.textContent || 'Senza titolo';
                    
                    if (!start || !stop) {
                        debugLog(`Programma ${index} senza start/stop`, 'error');
                        return;
                    }
                    
                    const startDate = parseDate(start);
                    const stopDate = parseDate(stop);
                    const duration = (stopDate - startDate) / 1000; // seconds
                    
                    programs.push({
                        start: startDate,
                        stop: stopDate,
                        title: title,
                        duration: duration,
                        desc: prog.querySelector('desc')?.textContent || '',
                        category: prog.querySelector('category')?.textContent || ''
                    });
                    
                } catch (e) {
                    debugLog(`Errore parsing programma ${index}: ${e.message}`, 'error');
                }
            });
            
            debugLog(`Parsati ${programs.length} programmi validi`, 'success');
            
            if (programs.length > 0) {
                displayData();
            } else {
                debugLog('Nessun programma valido trovato', 'error');
            }
        }

        // Parse XMLTV date
        function parseDate(dateStr) {
            // Handle both formats: YYYYMMDDHHmmss +0000 and YYYY-MM-DDTHH:mm:ss+0000
            if (dateStr.includes('T')) {
                return new Date(dateStr.replace(/\+\d{4}$/, 'Z'));
            } else {
                const year = dateStr.substr(0, 4);
                const month = dateStr.substr(4, 2);
                const day = dateStr.substr(6, 2);
                const hour = dateStr.substr(8, 2);
                const minute = dateStr.substr(10, 2);
                const second = dateStr.substr(12, 2);
                return new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}Z`);
            }
        }

        // Display data
        function displayData() {
            debugLog('Visualizzazione dati...');
            
            // Show sections
            document.getElementById('channelInfo').classList.remove('hidden');
            document.getElementById('treemapSection').classList.remove('hidden');
            document.getElementById('programList').classList.remove('hidden');
            
            // Update channel info
            document.getElementById('channelName').textContent = channelName;
            document.getElementById('channelId').textContent = channelId;
            document.getElementById('programCount').textContent = programs.length;
            
            // Sort programs
            programs.sort((a, b) => a.start - b.start);
            
            // Display programs
            displayProgramList();
            
            // Draw treemap
            drawTreemap();
        }

        // Display program list
        function displayProgramList() {
            debugLog('Creazione lista programmi...');
            
            const tbody = document.getElementById('programTableBody');
            tbody.innerHTML = '';
            
            programs.forEach((prog, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2">${prog.start.toLocaleTimeString()}</td>
                    <td class="px-4 py-2">${prog.stop.toLocaleTimeString()}</td>
                    <td class="px-4 py-2 font-medium">${prog.title}</td>
                    <td class="px-4 py-2">${Math.round(prog.duration / 60)} min</td>
                `;
                tbody.appendChild(row);
            });
            
            debugLog(`Aggiunti ${programs.length} programmi alla tabella`, 'success');
        }

        // Draw treemap
        function drawTreemap() {
            debugLog('Creazione treemap...');
            
            const container = document.getElementById('treemapContainer');
            container.innerHTML = '<div class="fill-indicator" id="fillIndicator">0% riempito</div>';
            
            // Aggregate by format
            const formats = {};
            programs.forEach(prog => {
                if (!formats[prog.title]) {
                    formats[prog.title] = {
                        title: prog.title,
                        duration: 0,
                        count: 0
                    };
                }
                formats[prog.title].duration += prog.duration;
                formats[prog.title].count++;
            });
            
            debugLog(`Aggregati ${Object.keys(formats).length} format unici`);
            
            // Convert to array and sort
            const formatArray = Object.values(formats).sort((a, b) => b.duration - a.duration);
            
            // Calculate total duration
            const totalDuration = formatArray.reduce((sum, f) => sum + f.duration, 0);
            const dayDuration = 24 * 60 * 60; // 24 hours in seconds
            const fillPercent = (totalDuration / dayDuration * 100).toFixed(1);
            
            document.getElementById('fillIndicator').textContent = `${fillPercent}% riempito`;
            
            // Simple treemap layout
            const containerWidth = 796; // 800 - 4 for border
            const containerHeight = 796;
            let x = 0, y = 0;
            let rowHeight = 0;
            
            formatArray.forEach((format, index) => {
                const area = (format.duration / totalDuration) * (containerWidth * containerHeight);
                const width = Math.sqrt(area * 1.5); // Make rectangles wider
                const height = area / width;
                
                // Check if need new row
                if (x + width > containerWidth) {
                    x = 0;
                    y += rowHeight;
                    rowHeight = 0;
                }
                
                // Create element
                const div = document.createElement('div');
                div.className = 'treemap-item';
                div.style.left = x + 'px';
                div.style.top = y + 'px';
                div.style.width = width + 'px';
                div.style.height = height + 'px';
                div.style.backgroundColor = colors[index % colors.length];
                div.innerHTML = `
                    <div style="padding: 5px;">
                        <div>${format.title}</div>
                        <div style="font-size: 0.8em;">${Math.round(format.duration / 60)} min</div>
                    </div>
                `;
                
                container.appendChild(div);
                
                x += width;
                rowHeight = Math.max(rowHeight, height);
                
                debugLog(`Creato elemento treemap: ${format.title} (${width.toFixed(0)}x${height.toFixed(0)})`);
            });
            
            debugLog('Treemap completato', 'success');
        }

        // Load test file
        function loadTestFile() {
            debugLog('Caricamento file di test...');
            
            const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<tv>
  <channel id="TestChannel">
    <display-name lang="it">Canale Test</display-name>
  </channel>
  
  <programme start="2024-01-10T06:00:00+0000" stop="2024-01-10T08:00:00+0000" channel="TestChannel">
    <title lang="it">Programma Mattina</title>
    <desc lang="it">Descrizione del programma mattutino</desc>
    <category lang="it">News</category>
  </programme>
  
  <programme start="2024-01-10T08:00:00+0000" stop="2024-01-10T10:30:00+0000" channel="TestChannel">
    <title lang="it">Talk Show</title>
    <desc lang="it">Talk show del mattino</desc>
    <category lang="it">Entertainment</category>
  </programme>
  
  <programme start="2024-01-10T10:30:00+0000" stop="2024-01-10T12:00:00+0000" channel="TestChannel">
    <title lang="it">Programma Mattina</title>
    <desc lang="it">Seconda edizione</desc>
    <category lang="it">News</category>
  </programme>
  
  <programme start="2024-01-10T12:00:00+0000" stop="2024-01-10T14:00:00+0000" channel="TestChannel">
    <title lang="it">Film del Pomeriggio</title>
    <desc lang="it">Film drammatico</desc>
    <category lang="it">Movie</category>
  </programme>
  
  <programme start="2024-01-10T14:00:00+0000" stop="2024-01-10T16:00:00+0000" channel="TestChannel">
    <title lang="it">Serie TV</title>
    <desc lang="it">Episodi della serie</desc>
    <category lang="it">Series</category>
  </programme>
  
  <programme start="2024-01-10T16:00:00+0000" stop="2024-01-10T18:00:00+0000" channel="TestChannel">
    <title lang="it">Talk Show</title>
    <desc lang="it">Talk show pomeridiano</desc>
    <category lang="it">Entertainment</category>
  </programme>
  
  <programme start="2024-01-10T18:00:00+0000" stop="2024-01-10T20:00:00+0000" channel="TestChannel">
    <title lang="it">Telegiornale</title>
    <desc lang="it">Notizie della sera</desc>
    <category lang="it">News</category>
  </programme>
  
  <programme start="2024-01-10T20:00:00+0000" stop="2024-01-10T21:00:00+0000" channel="TestChannel">
    <title lang="it">Quiz Show</title>
    <desc lang="it">Quiz a premi</desc>
    <category lang="it">Game Show</category>
  </programme>
  
  <programme start="2024-01-10T21:00:00+0000" stop="2024-01-10T23:00:00+0000" channel="TestChannel">
    <title lang="it">Film Prime Time</title>
    <desc lang="it">Film blockbuster</desc>
    <category lang="it">Movie</category>
  </programme>
  
  <programme start="2024-01-10T23:00:00+0000" stop="2024-01-11T01:00:00+0000" channel="TestChannel">
    <title lang="it">Talk Show</title>
    <desc lang="it">Talk show notturno</desc>
    <category lang="it">Entertainment</category>
  </programme>
</tv>`;
            
            parseXML(testXML);
        }
    </script>
</body>
</html>
